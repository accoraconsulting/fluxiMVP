<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FLUXI | Mis Wallets</title>

  <!--  VALIDACIN DE SESIN - EJECUTA ANTES DE RENDERIZAR -->
  <script>
    (function() {
      const token = localStorage.getItem('auth_token');
      const logoutTime = localStorage.getItem('logout_timestamp');
      if (!token || logoutTime) {
        localStorage.clear();
        window.location.replace('./login.html');
      }
    })();
  </script>


  <!-- Boxicons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

  <!-- Sidebar -->
  <link rel="stylesheet" href="./css/css-dashboard/css-sidebar.css" />


    <!-- Estilos del widget -->
    <link rel="stylesheet" href="css/notification-widget.css">
  <!-- Notification Widget - Navbar Unificado -->
  <link rel="stylesheet" href="./css/notification-widget-unified.css" />
  <!-- Navbar Unificado -->
  <link rel="stylesheet" href="./css/navbar-unified.css" />
  <!-- Wallet CSS -->
  <link rel="stylesheet" href="./css/css-dashboard/wallet.css" />
</head>

<body>
<div class="app-layout">

  <!-- SIDEBAR -->
  <div id="sidebar-container"></div>

  <!-- MAIN -->
  <main class="main-content">

    <!-- NAVBAR UNIFICADO -->
    <header class="fluxi-navbar">
      <div class="fluxi-navbar-left">
        <h1 class="fluxi-page-title" id="navbarPageTitle">Mis Wallets</h1>
      </div>
      <div class="fluxi-navbar-brand">
        <img src="assets/fluxi.png" class="fluxi-navbar-brand-logo" alt="FLUXI Logo" />
      </div>
      <div class="fluxi-navbar-right">
        <div class="fluxi-notification-icon" id="navNotificationIcon">
          <i class="bx bx-bell"></i>
          <span class="fluxi-notification-badge" id="navNotificationBadge" style="display: none;">0</span>
        </div>
        <div class="fluxi-user" id="navUserButton">
          <img src="./assets/mascota.jpeg" alt="Avatar" class="fluxi-user-avatar" id="navUserAvatar" />
          <span class="fluxi-username" id="navUsername">Usuario</span>
          <div class="fluxi-user-menu" id="navUserMenu">
            <button class="fluxi-user-menu-item" onclick="navigateToProfile()">
              <i class="bx bx-user"></i>
              <span>Mi Perfil</span>
            </button>
            <button class="fluxi-user-menu-item" onclick="navigateToSettings()">
              <i class="bx bx-cog"></i>
              <span>Configuraci贸n</span>
            </button>
            <div class="fluxi-user-menu-divider"></div>
            <button class="fluxi-user-menu-item" onclick="logout()" style="color: #f5576c;">
              <i class="bx bx-log-out"></i>
              <span>Cerrar Sesi贸n</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- BALANCE HERO -->
    <section class="balance-hero">
      <div class="balance-info">
        <span class="label">Balance Total</span>
        <h2 id="total-balance-amount">$0.00</h2>
        <small>
          <i class="bx bx-trending-up"></i>
          <span class="positive">Actualizado</span>
        </small>
      </div>

      <div class="balance-actions">
        <button class="hero-btn primary" id="btnTopupGlobal" disabled title="Recargar - Pr贸ximamente disponible">
          <i class="bx bx-plus-circle"></i>
          Recargar
        </button>
        <button class="hero-btn" id="btnWithdrawGlobal" disabled title="Retirar - Pr贸ximamente disponible">
          <i class="bx bx-minus-circle"></i>
          Retirar
        </button>
      </div>
    </section>

    <!-- ASSETS GRID -->
    <section class="assets-section">
      <div class="assets-grid" id="walletsContainer">
        <!-- Loading placeholder -->
        <div class="asset-card muted">
          <i class="bx bx-loader-alt bx-spin"></i>
          Cargando wallets...
        </div>
      </div>
    </section>

    <!-- RECENT ACTIVITY -->
    <section class="recent-activity">
      <h3>
        <i class="bx bx-time-five"></i>
        Movimientos Recientes
      </h3>

      <ul class="activity-list" id="movementsContainer">
        <li class="empty-state">
          <i class="bx bx-receipt"></i>
          <p>Cargando movimientos...</p>
        </li>
      </ul>
    </section>

  </main>
</div>

<!-- MODAL RECARGAR -->
<div id="topupModal" class="wallet-modal-overlay hidden" style="display: none;">
  <div class="wallet-modal-backdrop"></div>
  
  <div class="wallet-modal-content">
    <div class="wallet-modal-header">
      <h3>
        <i class="bx bx-plus-circle"></i>
        Recargar Wallet
      </h3>
      <button class="modal-close-btn" id="closeTopupModal">
        <i class="bx bx-x"></i>
      </button>
    </div>

    <div class="wallet-modal-body">
      <!-- Info de la wallet seleccionada -->
      <div id="topupWalletInfo" class="wallet-info-container"></div>

      <!-- Input de monto -->
      <div class="form-group">
        <label for="topupAmount">Monto a recargar</label>
        <input 
          type="number" 
          id="topupAmount" 
          placeholder="0.00" 
          min="0" 
          step="0.01" 
        />
      </div>

      <!-- Mensaje de error/info -->
      <p class="modal-message" id="topupMessage"></p>
    </div>

    <div class="wallet-modal-footer">
      <button class="modal-btn cancel" id="cancelTopup">
        Cancelar
      </button>
      <button class="modal-btn primary" id="confirmTopup">
        <i class="bx bx-check"></i>
        Confirmar Recarga
      </button>
    </div>
  </div>
</div>

<!-- MODAL RETIRAR -->
<div id="withdrawModal" class="wallet-modal-overlay hidden" style="display: none;">
  <div class="wallet-modal-backdrop"></div>
  
  <div class="wallet-modal-content">
    <div class="wallet-modal-header">
      <h3>
        <i class="bx bx-minus-circle"></i>
        Retirar Fondos
      </h3>
      <button class="modal-close-btn" id="closeWithdrawModal">
        <i class="bx bx-x"></i>
      </button>
    </div>

    <div class="wallet-modal-body">
      <!-- Info de la wallet seleccionada -->
      <div id="withdrawWalletInfo" class="wallet-info-container"></div>

      <!-- Input de monto -->
      <div class="form-group">
        <label for="withdrawAmount">Monto a retirar</label>
        <input 
          type="number" 
          id="withdrawAmount" 
          placeholder="0.00" 
          min="0" 
          step="0.01" 
        />
      </div>

      <!-- Input de descripci贸n -->
      <div class="form-group">
        <label for="withdrawDescription">Descripci贸n (opcional)</label>
        <textarea 
          id="withdrawDescription" 
          placeholder="Motivo del retiro..."
          rows="3"
        ></textarea>
      </div>

      <!-- Mensaje de error/info -->
      <p class="modal-message" id="withdrawMessage"></p>
    </div>

    <div class="wallet-modal-footer">
      <button class="modal-btn cancel" id="cancelWithdraw">
        Cancelar
      </button>
      <button class="modal-btn primary" id="confirmWithdraw">
        <i class="bx bx-check"></i>
        Confirmar Retiro
      </button>
    </div>
  </div>
</div>

<!-- 锔 SCRIPT PARA CERRAR MODALES AL CARGAR -->
<script>
  // Asegurar que todos los modales est茅n cerrados al cargar la p谩gina
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('topupModal')?.classList.add('hidden');
    document.getElementById('withdrawModal')?.classList.add('hidden');
  });
</script>

<!-- JS -->
<script src="./js/js-dashboard/sidebar-loader.js" type="module"></script>
<script src="./js/js-dashboard/wallet.user.js" type="module"></script>


  <!-- Widget de notificaciones -->
  <script type="module" src="js/notification-widget.js"></script>
  <script src="./js/navbar-unified.js"></script>
<!--  SISTEMA DE PERMISOS GLOBAL -->
<script type="module" src="./js/permissions/init-permissions.js"></script>
</body>
</html>