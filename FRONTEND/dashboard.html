<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FLUXI | Dashboard</title>

  <!-- üîê VALIDACI√ìN DE SESI√ìN - EJECUTA ANTES DE RENDERIZAR -->
  <script>
    (function() {
      const token = localStorage.getItem('auth_token');
      const logoutTime = localStorage.getItem('logout_timestamp');
      if (!token || logoutTime) {
        localStorage.clear();
        window.location.replace('./login.html');
      }
    })();
  </script>


  <!-- Boxicons -->
  <link
    href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
    rel="stylesheet"
  />

  <!-- Sidebar -->
  <link rel="stylesheet" href="./css/css-dashboard/css-sidebar.css" />
  <!-- Estilos del widget notificaciones -->
<link rel="stylesheet" href="css/notification-widget.css">
  <!-- Notification Widget - Navbar Unificado -->
  <link rel="stylesheet" href="./css/notification-widget-unified.css" />
  <!-- Navbar Unificado -->
  <link rel="stylesheet" href="./css/navbar-unified.css" />

  <!-- Dashboard -->
  <link rel="stylesheet" href="./css/css-dashboard/dashboard.css" />
</head>
<body>

  <!-- SIDEBAR -->
     <div class="app-layout">
  <div id="sidebar-container"></div>

    


  <!-- MAIN CONTENT -->
  <main class="main-content" id="mainContent">


     <!-- NAVBAR UNIFICADO -->
      <header class="fluxi-navbar">
        <div class="fluxi-navbar-left">
          <h1 class="fluxi-page-title" id="navbarPageTitle">Dashboard</h1>
        </div>
        <div class="fluxi-navbar-brand">
          <img src="./assets/fluxi.png" class="fluxi-navbar-brand-logo" alt="FLUXI Logo" />
        </div>
        <div class="fluxi-navbar-right">
          <div class="fluxi-notification-icon" id="navNotificationIcon">
            <i class="bx bx-bell"></i>
            <span class="fluxi-notification-badge" id="navNotificationBadge" style="display: none;">0</span>
          </div>
          <div class="fluxi-user" id="navUserButton">
            <img src="./assets/mascota.jpeg" alt="Avatar" class="fluxi-user-avatar" id="navUserAvatar" />
            <span class="fluxi-username" id="navUsername">Usuario</span>
            <div class="fluxi-user-menu" id="navUserMenu">
              <button class="fluxi-user-menu-item" onclick="navigateToProfile()">
                <i class="bx bx-user"></i>
                <span>Mi Perfil</span>
              </button>
              <button class="fluxi-user-menu-item" onclick="navigateToSettings()">
                <i class="bx bx-cog"></i>
                <span>Configuraci√≥n</span>
              </button>
              <div class="fluxi-user-menu-divider"></div>
              <button class="fluxi-user-menu-item" onclick="logout()" style="color: #f5576c;">
                <i class="bx bx-log-out"></i>
                <span>Cerrar Sesi√≥n</span>
              </button>
            </div>
          </div>
        </div>
      </header>


  
    <!-- BALANCES (requiere KYC) -->
    <section class="balances" id="dashboard-balances">
      <!-- Se llenar√° din√°micamente con JS -->
      <div class="balance-card primary">
        <p>Cargando...</p>
        <h2>---</h2>
        <span>---</span>
      </div>
    </section>

    <!-- BANNER KYC PENDIENTE (solo se muestra si NO tiene KYC aprobado) -->
    <section id="dashboard-kyc-banner" style="display: none; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 32px; color: white; text-align: center;">
        <i class="bx bx-shield-quarter" style="font-size: 48px; margin-bottom: 12px;"></i>
        <h2 style="margin: 0 0 8px 0; font-size: 22px;">Verifica tu identidad</h2>
        <p style="margin: 0 0 20px 0; opacity: 0.9; font-size: 15px;">
          Para acceder a todas las funcionalidades de FLUXI (wallet, transferencias, historial),
          necesitas completar tu verificaci√≥n de identidad.
        </p>
        <a href="./registerkyc.html"
           style="display: inline-block; padding: 12px 32px; background: white; color: #667eea; border-radius: 10px; font-weight: 700; text-decoration: none; font-size: 15px;">
          <i class="bx bx-id-card" style="font-size: 18px; vertical-align: middle;"></i>
          Verificar ahora
        </a>
      </div>
    </section>

    <!-- QUICK ACTIONS (requiere KYC) -->
<section class="quick-actions" id="dashboard-quick-actions" style="display: flex; gap: 16px; margin-bottom: 24px;">
  <button onclick="window.location.href='./wallet.html#recargar'"
          style="flex: 1; padding: 16px; background: #10b981; border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer;">
    <i class="bx bx-plus-circle" style="font-size: 20px;"></i>
    Recargar
  </button>

  <button onclick="window.location.href='./send.html#enviar'"
          style="flex: 1; padding: 16px; background: #3b82f6; border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer;">
    <i class="bx bx-send" style="font-size: 20px;"></i>
    Transferir
  </button>

  <button onclick="window.location.href='./moviments.html'"
          style="flex: 1; padding: 16px; background: #6366f1; border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer;">
    <i class="bx bx-receipt" style="font-size: 20px;"></i>
    Historial
  </button>
</section>


  <!-- CONVERTER (requiere KYC) -->
<section class="converter" id="dashboard-converter">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h3>Conversor de divisas</h3>
    <button id="refreshRatesBtn" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600;">
      <i class="bx bx-refresh"></i>
      Actualizar tasas
    </button>
  </div>

  <div class="converter-box">
    <!-- MONEDA ORIGEN -->
    <div class="converter-field">
      <label>De</label>
      <div style="display: flex; gap: 8px;">
        <input type="number" id="converterAmount" value="1000" min="0" step="0.01" style="flex: 2;">
        <select id="converterFrom" style="flex: 1;">
          <option value="">Cargando...</option>
        </select>
      </div>
      <small id="converterFromBalance" style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;"></small>
    </div>

    <!-- SWAP ICON -->
    <div class="converter-swap" style="cursor: pointer;">
      <i class="bx bx-transfer"></i>
    </div>

    <!-- MONEDA DESTINO -->
    <div class="converter-field">
      <label>A</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="converterResult" value="0.00" readonly style="flex: 2; background: #f8fafc;">
        <select id="converterTo" style="flex: 1;">
          <option value="">Cargando...</option>
        </select>
      </div>
      <small id="converterToBalance" style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;"></small>
    </div>

    <!-- BOT√ìN CONVERTIR -->
    <button class="btn-primary" id="btnConvert">Convertir</button>
  </div>

  <small id="converterRate" style="color: #64748b;">Cargando tasa de cambio...</small>
</section>
   
    <!-- MOVEMENTS (requiere KYC) -->
<section class="movements" id="dashboard-movements">
  <div class="section-header">
    <h3>Movimientos recientes</h3>
    <a href="./moviments.html" style="color: #3b82f6; text-decoration: none; font-size: 14px;">
      Ver todos ‚Üí
    </a>
  </div>

  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Destinatario/Origen</th>
        <th>Moneda</th>
        <th>Monto</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px;">
          <div class="loader"></div>
          <p style="margin-top: 16px; color: #7f8c8d;">Cargando movimientos...</p>
        </td>
      </tr>
    </tbody>
  </table>
</section>
<!-- MODAL DE CONFIRMACI√ìN DE CONVERSI√ìN -->
<div id="conversionModal" class="conversion-modal hidden">
  <div class="conversion-modal-backdrop"></div>
  
  <div class="conversion-modal-content">
    <!-- Header -->
    <div class="conversion-modal-header">
      <i class="bx bx-transfer" style="font-size: 28px; color: #667eea;"></i>
      <h3>Confirmar Conversi√≥n</h3>
      <button class="modal-close-btn" onclick="closeConversionModal()">
        <i class="bx bx-x"></i>
      </button>
    </div>

    <!-- Body -->
    <div class="conversion-modal-body">
      <div class="conversion-summary">
        <!-- FROM -->
        <div class="conversion-item">
          <span class="conversion-label">Convertir√°s</span>
          <div class="conversion-amount">
            <span id="modalAmountFrom" class="amount-value">1,000.00</span>
            <span id="modalCurrencyFrom" class="currency-badge">EUR</span>
          </div>
          <small id="modalBalanceFrom" class="balance-info">Balance: ‚Ç¨ 0.00</small>
        </div>

        <!-- ARROW -->
        <div class="conversion-arrow">
          <i class="bx bx-right-arrow-alt"></i>
        </div>

        <!-- TO -->
        <div class="conversion-item">
          <span class="conversion-label">Recibir√°s</span>
          <div class="conversion-amount">
            <span id="modalAmountTo" class="amount-value">1,090.12</span>
            <span id="modalCurrencyTo" class="currency-badge">USD</span>
          </div>
          <small id="modalBalanceTo" class="balance-info">Balance despu√©s: $ 1,090.12</small>
        </div>
      </div>

      <!-- Details -->
      <div class="conversion-details">
        <div class="detail-row">
          <span>Tasa de cambio</span>
          <strong id="modalRate">1.090120</strong>
        </div>
        <div class="detail-row">
          <span>Comisi√≥n (0.5%)</span>
          <strong id="modalFee">‚Ç¨ 5.00</strong>
        </div>
      </div>

      <!-- Warning -->
      <div class="conversion-warning">
        <i class="bx bx-info-circle"></i>
        <p>Esta conversi√≥n es irreversible. Verifica los montos antes de confirmar.</p>
      </div>
    </div>

    <!-- Footer -->
    <div class="conversion-modal-footer">
      <button class="btn-cancel" onclick="closeConversionModal()">
        Cancelar
      </button>
      <button class="btn-confirm" id="btnConfirmConversion">
        <i class="bx bx-check-circle"></i>
        Confirmar Conversi√≥n
      </button>
    </div>
  </div>
</div>
  </main>

  <div id="ratesIndicator" style="position: fixed; bottom: 20px; right: 20px; background: white; padding: 12px 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 12px; color: #64748b; display: flex; align-items: center; gap: 8px;">
  <i class="bx bx-trending-up" style="color: #10b981;"></i>
  <span id="ratesStatus">Tasas actualizadas</span>
</div>

  <!-- JS -->

  <!-- üîê Dashboard KYC Guard: oculta secciones si no tiene KYC aprobado -->
  <script>
    (function() {
      try {
        const raw = localStorage.getItem('auth_user');
        if (!raw) return;
        const user = JSON.parse(raw);
        const role = user.role || 'fluxiUser';
        const kycApproved = user.kyc_status === 'approved';

        // Solo fluxiUser necesita KYC para ver el dashboard completo
        // fluxiDocs, fluxiDev, fluxiAdmin tienen acceso completo siempre
        const needsKyc = (role === 'fluxiUser' && !kycApproved);

        const restricted = [
          'dashboard-balances',
          'dashboard-quick-actions',
          'dashboard-converter',
          'dashboard-movements'
        ];

        if (needsKyc) {
          restricted.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
          });
          const banner = document.getElementById('dashboard-kyc-banner');
          if (banner) banner.style.display = 'block';
        } else {
          const banner = document.getElementById('dashboard-kyc-banner');
          if (banner) banner.style.display = 'none';
        }
      } catch(e) {
        console.error('[Dashboard KYC Guard]', e);
      }
    })();
  </script>

   <script type="module" src="./js/js-dashboard/dashboard.js"></script>

<script src="./js/js-dashboard/sidebar-loader.js"></script>
<script type="module" src="./js/js-dashboard/dashboard-user.js"></script>
<!-- üí≥ Dashboard Payins - Estad√≠sticas de Links de Pago -->
<script src="./js/js-dashboard/dashboard-payins.js"></script>
<!-- Widget de notificaciones -->
<script type="module" src="js/notification-widget.js"></script>





  <script src="./js/navbar-unified.js"></script>
<!-- üîê SISTEMA DE PERMISOS GLOBAL -->
<script type="module" src="./js/permissions/init-permissions.js"></script>
</body>
</html>
